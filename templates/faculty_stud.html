{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <h2 class="mb-4 text-center">âœ… Take Attendance</h2>

  <!-- ðŸ”¹ Filter Form -->
  <form method="POST" action="{{ url_for('faculty_stud_bp.faculty_attendance') }}" class="border rounded p-4 mb-4 bg-light shadow-sm">
    <div class="row g-3">

      <div class="col-md-2">
        <label class="form-label">Program</label>
        <select name="program" class="form-select" required>
          <option value="">-- Program --</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Branch</label>
        <select name="branch" class="form-select" required>
          <option value="">-- Branch --</option>
        </select>
      </div>

      <div class="col-md-1">
        <label class="form-label">Year</label>
        <select name="year" class="form-select" required>
          <option value="">-- Y --</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Semester</label>
        <select name="semester" class="form-select" required>
          <option value="">-- Sem --</option>
        </select>
      </div>

      <div class="col-md-1">
        <label class="form-label">Section</label>
        <select name="section" class="form-select" required>
          <option value="">-- Sec --</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Date</label>
        <input type="date" name="date" value="{{ selected_date }}" class="form-control" required>
      </div>

      <div class="col-md-2 d-grid align-items-end">
        <button type="submit" class="btn btn-primary" name="load_students">
          ðŸ”„ Load Students
        </button>
      </div>

    </div>
  </form>

  <!-- ðŸ”¹ Attendance Table -->
  {% if students %}
  <form method="POST" action="{{ url_for('faculty_stud_bp.save_attendance') }}">
    
    {# Hidden filters passed back #}
    {% for hid in ['program','branch','year','semester','section','date'] %}
      <input type="hidden" name="{{ hid }}" value="{{ request.form.get(hid) or globals()['selected_' + hid] }}">
    {% endfor %}

    <!-- ðŸ”¹ Summary Cards -->
    <div id="attendance-summary" class="row text-center mb-3">
      <div class="col-md-3">
        <div class="card shadow-sm p-3">
          <h6>Total Students</h6>
          <span id="total-count" class="fw-bold fs-5">{{ students|length }}</span>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm p-3">
          <h6>Present</h6>
          <span id="present-count" class="fw-bold text-success fs-5">0</span>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm p-3">
          <h6>Absent</h6>
          <span id="absent-count" class="fw-bold text-danger fs-5">0</span>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm p-3">
          <h6>Attendance %</h6>
          <span id="percentage" class="fw-bold fs-5">0%</span>
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle shadow-sm">
        <thead class="table-dark text-center">
          <tr>
            <th>Roll No</th>
            <th>Name</th>
            <th style="width:130px">Present</th>
            <th>Remark (if Absent)</th>
          </tr>
        </thead>
        <tbody>
        {% for student in students %}
          <tr class="text-center {% if student.attendance_today %}table-success{% endif %}">
            <td>{{ student.roll_no }}</td>
            <td class="text-start">{{ student.name }}</td>
            <td>
              <div class="form-check form-switch d-flex justify-content-center">
                <input class="form-check-input attendance-checkbox"
                       type="checkbox"
                       role="switch"
                       id="att_{{ student.id }}"
                       name="attendance_{{ student.id }}"
                       {% if student.attendance_today %}checked{% endif %}>
              </div>
            </td>
            <td>
              <select name="remark_{{ student.id }}" class="form-select remark-select" {% if student.attendance_today %}disabled{% endif %}>
                <option value="">-- Remark --</option>
                <option>Misbehaviour / Indiscipline</option>
                <option>Leave (Health)</option>
                <option>Leave (Personal)</option>
                <option>Others</option>
              </select>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="text-end mt-3">
      <button type="submit" class="btn btn-success px-4">ðŸ’¾ Save Attendance</button>
    </div>
  </form>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // ðŸ”¹ Dropdown Loader
  const apiUrl = "{{ url_for('dropdowns_bp.get_dropdowns') }}";

  function populateDropdown(selectElement, options, placeholder) {
    if (!selectElement) return;
    selectElement.innerHTML = "";
    const placeholderOption = document.createElement("option");
    placeholderOption.value = "";
    placeholderOption.textContent = placeholder;
    selectElement.appendChild(placeholderOption);

    options.forEach(val => {
      const option = document.createElement("option");
      option.value = val;
      option.textContent = val;
      selectElement.appendChild(option);
    });
  }

  fetch(apiUrl)
    .then(res => res.json())
    .then(data => {
      populateDropdown(document.querySelector('[name="program"]'), data.program, "-- Program --");
      populateDropdown(document.querySelector('[name="branch"]'), data.branch, "-- Branch --");
      populateDropdown(document.querySelector('[name="year"]'), data.year, "-- Year --");
      populateDropdown(document.querySelector('[name="semester"]'), data.semester, "-- Sem --");
      populateDropdown(document.querySelector('[name="section"]'), data.section, "-- Section --");
    })
    .catch(err => console.error("Dropdown fetch failed:", err));

  // ðŸ”¹ Toggle Attendance Rows + Summary Update
  function updateSummary() {
    const checkboxes = document.querySelectorAll(".attendance-checkbox");
    let total = checkboxes.length;
    let present = 0;

    checkboxes.forEach(cb => { if (cb.checked) present++; });

    let absent = total - present;
    let pct = total ? ((present / total) * 100).toFixed(2) : 0;

    document.getElementById("total-count").textContent = total;
    document.getElementById("present-count").textContent = present;
    document.getElementById("absent-count").textContent = absent;
    document.getElementById("percentage").textContent = pct + "%";
  }

  function toggleRow(checkbox) {
    const row = checkbox.closest("tr");
    const remarkSelect = row.querySelector(".remark-select");

    if (checkbox.checked) {
      remarkSelect.disabled = true;
      remarkSelect.value = "";
      row.classList.add("table-success");
    } else {
      remarkSelect.disabled = false;
      row.classList.remove("table-success");
    }
    updateSummary();
  }

  document.querySelectorAll(".attendance-checkbox").forEach(cb => {
    toggleRow(cb);
    cb.addEventListener("change", () => toggleRow(cb));
  });

  updateSummary();
});
</script>
{% endblock %}
