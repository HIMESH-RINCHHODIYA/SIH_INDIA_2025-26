{% extends "base.html" %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container mt-5">
  <h2 class="text-center mb-4">üìò Manage Courses</h2>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Course Form -->
  <div class="card shadow p-4 mb-4">
    <form action="{{ url_for('course_bp.add_course') }}" method="POST">
      <div class="row g-3">
        <div class="col-md-6">
          <label for="course_name" class="form-label">Course Name</label>
          <input type="text" class="form-control" id="course_name" name="course_name" placeholder="Enter course name" required>
        </div>
        <div class="col-md-6">
          <label for="course_code" class="form-label">Course Code</label>
          <input type="text" class="form-control" id="course_code" name="course_code" placeholder="e.g. CS101" required>
        </div>
      </div>
      <button type="submit" class="btn btn-primary mt-3">‚ûï Add Course</button>
    </form>
  </div>
<a href="{{ url_for('dropdowns_bp.manage_dropdowns') }}" class="btn btn-secondary mb-3">
   ‚öôÔ∏è Manage Dropdowns
</a>

  <!-- Search and Download Options -->
  <div class="d-flex justify-content-between mb-3">
    <input type="text" id="searchInput" class="form-control w-50" placeholder="üîç Search by course name or code...">
    <div>
      <button class="btn btn-success me-2" onclick="downloadCSV()">‚¨áÔ∏è CSV</button>
      <button class="btn btn-danger" onclick="downloadPDF()">‚¨áÔ∏è PDF</button>
    </div>
  </div>

  <!-- Course Table -->
  <div class="card shadow">
    <div class="table-responsive">
      <table class="table table-striped mb-0" id="courseTable">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Course Name</th>
            <th>Course Code</th>
          </tr>
        </thead>
        <tbody id="courseTableBody">
          {% for c in courses %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ c.course_name }}</td>
            <td>{{ c.course_code }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  const searchInput = document.getElementById("searchInput");
  const rows = document.querySelectorAll("#courseTableBody tr");

  // Search Filter
  searchInput.addEventListener("input", () => {
    const query = searchInput.value.toLowerCase();
    rows.forEach(row => {
      const name = row.cells[1].textContent.toLowerCase();
      const code = row.cells[2].textContent.toLowerCase();
      row.style.display = (name.includes(query) || code.includes(query)) ? "" : "none";
    });
  });

  // CSV Download
  function downloadCSV() {
    let csv = "Course Name,Course Code\n";
    rows.forEach(row => {
      if (row.style.display !== "none") {
        csv += `${row.cells[1].textContent},${row.cells[2].textContent}\n`;
      }
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "courses.csv";
    link.click();
  }

  // PDF Download
  function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Courses List", 10, 10);

    let y = 20;
    rows.forEach((row, i) => {
      if (row.style.display !== "none") {
        doc.text(`${i+1}. ${row.cells[1].textContent} (${row.cells[2].textContent})`, 10, y);
        y += 10;
      }
    });

    doc.save("courses.pdf");
  }
</script>
{% endblock %}
