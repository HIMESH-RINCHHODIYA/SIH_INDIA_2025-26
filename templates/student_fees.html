<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Fee Payment</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Inter',sans-serif; margin:0; padding:0; color:#333; background:linear-gradient(-45deg,#ff6ec4,#7873f5,#4adede,#ffc371); background-size:400% 400%; animation:gradientBG 12s ease infinite;}
    @keyframes gradientBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    body.dark{background:#121212;color:#eee;}
    .container{max-width:800px;margin:60px auto;padding:35px;background:#fff;border-radius:20px;box-shadow:0 12px 30px rgba(0,0,0,0.15);position:relative;animation:fadeIn 0.9s ease-in-out;}
    body.dark .container{background:#1e1e1e;color:#ddd;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    h2{text-align:center;margin-bottom:25px;font-weight:700;font-size:28px;}
    .dashboard-btn{position:absolute;top:15px;left:15px;background:#f4f4f4;padding:10px 18px;border-radius:10px;text-decoration:none;color:#333;font-size:14px;}
    .dashboard-btn:hover{background:#ddd;}
    body.dark .dashboard-btn{background:#333;color:#eee;}
    .toggle-btn{position:absolute;top:15px;right:15px;background:#2575fc;color:white;padding:8px 16px;border-radius:10px;cursor:pointer;font-size:14px;border:none;}
    .toggle-btn:hover{opacity:.85;}
    .info-box{background:#f4f6f9;padding:20px;border-radius:14px;margin-bottom:25px;border-left:6px solid #6a11cb;}
    body.dark .info-box{background:#2a2a2a;}
    .info-box p{margin:8px 0;font-size:16px;}
    .status{font-weight:600;padding:6px 14px;border-radius:8px;font-size:14px;display:inline-block;}
    .Unpaid{background:#ffe6e6;color:#d32f2f;}
    .Pending{background:#fff4cc;color:#856404;}
    .Paid{background:#d4edda;color:#155724;}
    .Failed{background:#f8d7da;color:#721c24;}
    .btn{border:none;padding:12px 20px;border-radius:12px;font-size:15px;cursor:pointer;margin:8px 5px;transition:.3s;font-weight:600;}
    .pay-btn{background:linear-gradient(135deg,#6a11cb,#2575fc);color:#fff;}
    .verify-btn{background:#ff9800;color:white;}
    .receipt-btn{background:#4caf50;color:white;}
    .btn:hover{transform:scale(1.05);}
    #qr-container{margin-top:30px;display:none;text-align:center;}
    #qrcode{margin-top:15px;}
    
    /* Scrollable payment history */
    .history{margin-top:40px;}
    .history-scroll{max-height:300px; overflow-y:auto; border:1px solid #ddd; border-radius:12px;}
    .history-scroll table{width:100%; border-collapse:collapse;}
    .history-scroll th, .history-scroll td{padding:10px; border:1px solid #ddd; text-align:center;}
    .history-scroll th{position:sticky; top:0; background:#6a11cb; color:white; z-index:2;}
    body.dark .history-scroll th{background:#444;}
    
    #toast{visibility:hidden;min-width:250px;margin-left:-125px;background:#333;color:#fff;text-align:center;border-radius:10px;padding:14px;position:fixed;z-index:1000;left:50%;bottom:30px;font-size:15px;}
    @media(max-width:768px){.container{margin:20px 10px;padding:25px}.btn{width:100%}}
  </style>
</head>
<body>
<div class="container">
  <a href="/dashboard" class="dashboard-btn">‚¨Ö Back</a>
  <button class="toggle-btn" onclick="toggleMode()">üåô Mode</button>
  <h2>üéì Student Fee Payment</h2>

  {% if error_msg %}
    <div style="color:red;font-weight:bold;margin-top:20px;">{{ error_msg }}</div>
  {% else %}
    <div class="info-box">
      <p><strong>Name:</strong> {{ current_user.name }}</p>
      <p><strong>Program:</strong> {{ current_user.program }}</p>
      <p><strong>Branch:</strong> {{ current_user.branch }}</p>
      <p><strong>Year:</strong> {{ current_user.year }}</p>
      <p><strong>Total Fee:</strong> ‚Çπ{{ fee_config.amount }}</p>
      <p><strong>Total Paid:</strong> ‚Çπ{{ total_paid }}</p>
      <p><strong>Pending Dues:</strong> ‚Çπ{{ dues }}</p>
      <p><strong>Last Date:</strong> {{ fee_config.last_date }}</p>
      <p><strong>Status:</strong> 
        <span class="status {% if dues == 0 %}Paid{% elif total_paid > 0 %}Pending{% else %}Unpaid{% endif %}">
          {% if dues == 0 %}Paid{% elif total_paid > 0 %}Pending{% else %}Unpaid{% endif %}
        </span>
      </p>
    </div>

    {% if dues > 0 %}
    <form id="payForm">
      <input type="hidden" id="amount" value="{{ dues }}">
      <button type="submit" class="btn pay-btn" data-method="UPI">üí≥ Pay via UPI</button>
      <button type="submit" class="btn pay-btn" data-method="NetBanking">üè¶ Pay via NetBanking</button>
    </form>
    <button id="verifyBtn" class="btn verify-btn">üîç Verify Failed Payment</button>
    {% else %}
      <p style="color:green;font-weight:bold;margin-top:15px;">‚úÖ All fees are paid. Thank you!</p>
    {% endif %}

    <div id="qr-container">
      <h3>üì± Scan & Pay</h3>
      <canvas id="qrcode"></canvas>
    </div>

    <div class="history">
      <h3>üìë Payment History</h3>
      {% if payments %}
      <div class="history-scroll">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Receipt</th>
            </tr>
          </thead>
          <tbody>
            {% for p in payments %}
            <tr>
              <td>{{ p.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
              <td>‚Çπ{{ p.amount }}</td>
              <td><span class="status {{ p.status }}">{{ p.status }}</span></td>
              <td>
                {% if p.status=="Paid" %}
                  <a href="{{ url_for('student_fee.download_receipt', payment_id=p.id) }}" class="btn receipt-btn">‚¨á Receipt</a>
                {% else %}-{% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p>No payments found.</p>
      {% endif %}
    </div>
  {% endif %}
</div>

<div id="toast"></div>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
function showToast(msg){ const t=document.getElementById("toast"); t.innerText=msg; t.style.visibility="visible"; setTimeout(()=>t.style.visibility="hidden",3000);}
function toggleMode(){ document.body.classList.toggle("dark");}

document.getElementById("payForm")?.addEventListener("click", async function(e){
  if(e.target.tagName!=="BUTTON") return;
  e.preventDefault();
  const method=e.target.dataset.method;
  const amount=document.getElementById("amount").value;

  const res=await fetch("/student/fees/create",{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:new URLSearchParams({amount,method})
  });
  const data=await res.json();
  if(data.error){ showToast(data.error); return; }

  if(data.method==="UPI"){
    document.getElementById("qr-container").style.display="block";
    QRCode.toCanvas(document.getElementById("qrcode"), data.upi_url);
    showToast("UPI QR generated!");
  } else if(data.method==="NetBanking"){
    showToast("Redirecting to NetBanking...");
    window.location.href = data.redirect_url;
  }
});

document.getElementById("verifyBtn")?.addEventListener("click", async function(){
  const res=await fetch("/student/fees/verify");
  const data=await res.json();
  showToast(data.message||"Verification complete!");
  setTimeout(()=>location.reload(),1000);
});
</script>
</body>
</html>
